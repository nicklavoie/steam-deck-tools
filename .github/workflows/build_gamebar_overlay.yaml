on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build_gamebar_overlay.yaml"
      - "NickGameBar.TelemetryHost/**"
      - "NickGameBar.GameBarWidget/**"
      - "PerformanceOverlay/**"
      - "CommonHelpers/**"
      - "ExternalHelpers/**"
      - "VERSION"
  pull_request:
    paths:
      - ".github/workflows/build_gamebar_overlay.yaml"
      - "NickGameBar.TelemetryHost/**"
      - "NickGameBar.GameBarWidget/**"
      - "PerformanceOverlay/**"
      - "CommonHelpers/**"
      - "ExternalHelpers/**"
      - "VERSION"

env:
  DOTNET_VERSION: "8.0.x"
  APP_NAME: NickGameBar
  TELEMETRY_RUNTIME: win-x64

jobs:
  build-gamebar:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Set RELEASE_VERSION
        shell: pwsh
        run: |
          $majorVersion = (Get-Content VERSION -Raw).Trim()
          $releaseVersion = "$majorVersion.${{ github.run_number }}"
          "RELEASE_VERSION=$releaseVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Restore TelemetryHost dependencies
        run: dotnet restore NickGameBar.TelemetryHost/NickGameBar.TelemetryHost.csproj

      - name: Build TelemetryHost
        run: dotnet publish NickGameBar.TelemetryHost/NickGameBar.TelemetryHost.csproj --configuration Release --runtime ${{ env.TELEMETRY_RUNTIME }} --self-contained true --output "out/TelemetryHost" "/property:Version=${{ env.RELEASE_VERSION }}"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Create widget signing certificate
        shell: pwsh
        run: |
          $certPasswordPlain = [Guid]::NewGuid().ToString("N")
          $certPassword = ConvertTo-SecureString -String $certPasswordPlain -AsPlainText -Force
          $pfxPath = Join-Path $PWD "NickGameBar.GameBarWidget\NickGameBar.GameBarWidget_TemporaryKey.pfx"
          $cerPath = Join-Path $PWD "NickGameBar.GameBarWidget\NickGameBar.GameBarWidget.cer"

          $cert = New-SelfSignedCertificate `
            -Type Custom `
            -Subject "CN=NickGameBar" `
            -KeyUsage DigitalSignature `
            -FriendlyName "NickGameBar CI Signing Certificate" `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -KeyExportPolicy Exportable `
            -HashAlgorithm "SHA256" `
            -NotAfter (Get-Date).AddYears(5)

          Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $certPassword | Out-Null
          Export-Certificate -Cert $cert -FilePath $cerPath | Out-Null

          "WIDGET_PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "WIDGET_PFX_PASSWORD=$certPasswordPlain" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "WIDGET_CERT_PATH=$cerPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "WIDGET_CERT_THUMBPRINT=$($cert.Thumbprint)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build Game Bar widget appx bundle
        shell: pwsh
        run: |
          $pfxPath = "${{ env.WIDGET_PFX_PATH }}"
          $pfxPassword = "${{ env.WIDGET_PFX_PASSWORD }}"
          msbuild NickGameBar.GameBarWidget/NickGameBar.GameBarWidget.csproj /restore /p:Configuration=Release /p:Platform=x64 /p:GenerateAppxPackageOnBuild=true /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxBundle=Always /p:AppxBundlePlatforms=x64 /p:AppxPackageSigningEnabled=true /p:PackageCertificateKeyFile="$pfxPath" /p:PackageCertificatePassword="$pfxPassword" /p:PackageCertificateThumbprint=

      - name: Collect release payload
        shell: pwsh
        run: |
          $root = "release/${{ env.APP_NAME }}-${{ env.RELEASE_VERSION }}"
          New-Item -ItemType Directory -Force -Path "$root/Program Files/Nick Lavoie/PerformanceOverlay/NickGameBar.TelemetryHost" | Out-Null
          New-Item -ItemType Directory -Force -Path "$root/AppPackages/NickGameBar.GameBarWidget" | Out-Null

          Copy-Item -Path "out/TelemetryHost/*" -Destination "$root/Program Files/Nick Lavoie/PerformanceOverlay/NickGameBar.TelemetryHost" -Recurse -Force

          $pkgDir = Get-ChildItem "NickGameBar.GameBarWidget/AppPackages" -Directory -ErrorAction Stop | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          Copy-Item -Path "$($pkgDir.FullName)/*" -Destination "$root/AppPackages/NickGameBar.GameBarWidget" -Recurse -Force
          Copy-Item -Path "${{ env.WIDGET_CERT_PATH }}" -Destination "$root/AppPackages/NickGameBar.GameBarWidget/NickGameBar.GameBarWidget.cer" -Force

          $installScript = @'
          param(
              [string]$DestinationRoot = "$env:ProgramFiles\Nick Lavoie\PerformanceOverlay",
              [switch]$SkipHostInstall,
              [switch]$SkipWidgetInstall
          )

          $ErrorActionPreference = 'Stop'

          $payloadRoot = Split-Path -Parent $PSCommandPath
          $hostSource = Join-Path $payloadRoot "Program Files\Nick Lavoie\PerformanceOverlay\NickGameBar.TelemetryHost"
          $widgetRoot = Join-Path $payloadRoot "AppPackages\NickGameBar.GameBarWidget"

          if (-not $SkipHostInstall) {
              if (-not (Test-Path -LiteralPath $hostSource)) {
                  throw "Telemetry host payload not found at '$hostSource'."
              }

              if (-not (Test-Path -LiteralPath $DestinationRoot)) {
                  New-Item -ItemType Directory -Path $DestinationRoot -Force | Out-Null
              }

              $destinationHostDir = Join-Path $DestinationRoot "NickGameBar.TelemetryHost"
              New-Item -ItemType Directory -Path $destinationHostDir -Force | Out-Null
              Copy-Item -Path (Join-Path $hostSource '*') -Destination $destinationHostDir -Recurse -Force
              Write-Host "Telemetry host installed to: $destinationHostDir"
          }

          if (-not $SkipWidgetInstall) {
              if (-not (Test-Path -LiteralPath $widgetRoot)) {
                  throw "Widget payload not found at '$widgetRoot'."
              }

              $certPath = Join-Path $widgetRoot "NickGameBar.GameBarWidget.cer"
              if (Test-Path -LiteralPath $certPath) {
                  $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($certPath)
                  $store = New-Object System.Security.Cryptography.X509Certificates.X509Store("TrustedPeople", "CurrentUser")
                  $store.Open([System.Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)
                  $store.Add($cert)
                  $store.Close()
                  Write-Host "Imported widget signing certificate into CurrentUser\TrustedPeople."
              } else {
                  Write-Warning "Signing certificate was not found. Package install might fail."
              }

              $package = Get-ChildItem -Path $widgetRoot -Recurse -File |
                  Where-Object { $_.Extension -in ".msixbundle", ".appxbundle", ".msix", ".appx" } |
                  Sort-Object LastWriteTime -Descending |
                  Select-Object -First 1

              if (-not $package) {
                  throw "No app package found under '$widgetRoot'."
              }

              $dependencyPath = Join-Path $widgetRoot "Dependencies"
              $dependencies = @()
              if (Test-Path -LiteralPath $dependencyPath) {
                  $dependencies = Get-ChildItem -Path $dependencyPath -Recurse -File |
                      Where-Object { $_.Extension -in ".appx", ".msix" } |
                      Select-Object -ExpandProperty FullName
              }

              if ($dependencies.Count -gt 0) {
                  Add-AppxPackage -Path $package.FullName -DependencyPath $dependencies -ForceApplicationShutdown
              } else {
                  Add-AppxPackage -Path $package.FullName -ForceApplicationShutdown
              }

              Write-Host "Widget installed from: $($package.FullName)"
          }

          Write-Host "Done. Start the telemetry host executable, then open Xbox Game Bar (Win+G) and add the Nick Telemetry widget."
          '@

          Set-Content -Path "$root/Install-GameBarOverlay.ps1" -Value $installScript -Encoding UTF8

      - name: Create zip artifact
        shell: pwsh
        run: |
          Compress-Archive -Path "release/${{ env.APP_NAME }}-${{ env.RELEASE_VERSION }}/*" -DestinationPath "${{ env.APP_NAME }}-${{ env.RELEASE_VERSION }}.zip"

      - name: Upload Game Bar zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ env.RELEASE_VERSION }}.zip
          path: ${{ env.APP_NAME }}-${{ env.RELEASE_VERSION }}.zip
          retention-days: 14

      - name: Cleanup signing certificate
        if: always()
        shell: pwsh
        run: |
          if (Test-Path -LiteralPath "${{ env.WIDGET_PFX_PATH }}") {
              Remove-Item -LiteralPath "${{ env.WIDGET_PFX_PATH }}" -Force -ErrorAction SilentlyContinue
          }

          if (Test-Path -LiteralPath "${{ env.WIDGET_CERT_PATH }}") {
              Remove-Item -LiteralPath "${{ env.WIDGET_CERT_PATH }}" -Force -ErrorAction SilentlyContinue
          }

          $thumbprint = "${{ env.WIDGET_CERT_THUMBPRINT }}"
          if ($thumbprint) {
              $certPath = "Cert:\CurrentUser\My\$thumbprint"
              if (Test-Path -LiteralPath $certPath) {
                  Remove-Item -LiteralPath $certPath -Force -ErrorAction SilentlyContinue
              }
          }
